{% extends 'core/base.html' %}
{% block title %}Archiwum{% endblock %}
{% load crispy_forms_tags %}
{% block content %}
    {% if request.user.is_authenticated %}
        {% if worksheets_list %}
            <div class="level">
                <div class="level-left">
                    <div class="level-item">
                        <p class="control has-icons-left">
                            <label>
                                <input class="input is-colored has-colored-placeholder" placeholder="Szukaj prób" id="worksheet_searchbar" onkeyup="filter_by_name(this.value)">
                            </label>
                            <span class="icon is-small is-left">
                                <i class="fa-solid fa-magnifying-glass"></i>
                            </span>
                        </p>
                    </div>
                </div>
                <div class="level-right">
                    <div class="level-item">
                        <div class="select">
                            <label>
                                <select name="patrol_select" id= "patrol_selector" class="select is-colored"
                                        onchange="filter_by_patrol(this.value)">
                                    <option value="all">Wszystkie zastępy</option>
                                    {% for patrol in patrols %}
                                        <option value={{ patrol.id }}>{{ patrol.name }}</option>
                                    {% endfor %}
                                </select>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            {% for worksheet in worksheets_list %}
                <div class="block worksheet" id="worksheet_{{ worksheet.id }}" data-user-patrol="{{ worksheet.user.patrol.id }}">
                    <div class="box">
        <span class="icon-text is-align-items-center">
            <span class="title" style="margin-bottom: 0">{{ worksheet }} </span>
            <span class="icon has-tooltip-bottom has-tooltip-arrow" id="tooltip_text_{{ worksheet.id }}_print"
                  data-tooltip="Drukuj próbę"><span onclick="location.href='{% url 'worksheets:print_worksheet' worksheet.id %}'"><i class="fas fa-print"></i></span></span>
            <span class="icon has-tooltip-bottom has-tooltip-arrow" id="tooltip_text_{{ worksheet.id }}_print"
                  data-tooltip="Przywróć próbę"><span
                    onclick="confirm_popup(null, 'Czy na pewno chcesz przywrócić tę próbę?', fun=function(){$.ajax({'url': '{% url 'api-worksheets-list' %}{{ worksheet.id }}/', 'type': 'patch', 'headers': {'X-CSRFToken': '{{ csrf_token }}'}, 'dataType': 'json', 'data': {'is_archived': 'false'}, 'success': function () {alert('Próba została przywrócona.'); $('#worksheet_{{ worksheet.id }}').remove();}}) })"><i class="fa-solid fa-box-open"></i></span></span>
            {% if user.function > 2 %}
                <span class="icon has-tooltip-bottom has-tooltip-arrow" id="tooltip_text_{{ worksheet.id }}_print"
                      data-tooltip="Usuń próbę na zawsze"><span
                        onclick="confirm_popup(null, 'Czy na pewno chcesz usunąć tę próbę? \nJest to permanentne i nie będziesz w stanie nigdy cofnąć tej akcji (nawet Tony Stark - geniusz, miliarder, playboy i filantrop nie bułby w stanie tego dokonać więc bądź ostrożny 😷).', fun=function(){$.ajax({'url': '{% url 'api-worksheets-list' %}{{ worksheet.id }}/?archived', 'type': 'delete', 'headers': {'X-CSRFToken': '{{ csrf_token }}'}, 'dataType': 'json', 'success': function () {alert('Próba została usunięta.'); $('#worksheet_{{ worksheet.id }}').remove();}}) })"><i class="fa-solid fa-trash"></i></span></span>
            {% endif %}
        </span>
                        {% if worksheet.supervisor %}
                            <h2 class="subtitle">Opiekun próby: <a
                                    href="{% url 'view_profile' user_id=worksheet.supervisor.user.id %}">{{ worksheet.supervisor.user.full_name_nickname }}</a>
                            </h2>
                        {% endif %}
                        <p><br/></p>
                        <table class="table">
                            <thead>
                            <tr>
                                <th class="is-narrow">Lp.</th>
                                <th>Zadanie</th>
                                {% if worksheet.show_description_column %}
                                    <th>Opis</th>
                                {% endif %}
                                <th style="width:4rem">Status</th>
                            </tr>
                            </thead>
                            <tfoot>
                            <tr>
                                <th></th>
                                <th></th>
                                {% if worksheet.show_description_column %}
                                    <th></th>
                                {% endif %}
                                <th><span class="has-tooltip-arrow has-tooltip-left has-tooltip-primary"
                                          data-tooltip="Procent wykonanych zadań">{{ worksheet.percent }}</span></th>
                            </tr>
                            </tfoot>
                            <tbody>
                            {% for task in worksheet.tasks.all %}
                                <tr>
                                    <th>{{ forloop.counter }}</th>
                                    <td>{{ task.task }}</td>
                                    {% if worksheet.show_description_column %}
                                        {% if task.description != "" %}
                                            <td>{{ task.description }}</td>
                                        {% else %}
                                            <td></td>
                                        {% endif %}
                                    {% endif %}
                                    {% if task.status == 2 %}
                                        <td>
                                            <div id="status-icon_{{ task.id }}"><span
                                                    class="has-tooltip-arrow has-tooltip-left"
                                                    data-tooltip="{{ task.approver }} zatwierdził {{ task.approval_date }}"><i
                                                    class="far fa-check-circle"></i></span></div>
                                        </td>
                                    {% elif task.status == 1 %}
                                        <td>
                                            <div id="status-icon_{{ task.id }}"><span
                                                    class="has-tooltip-arrow has-tooltip-left"
                                                    data-tooltip="{{ task.approval_date }} wysłano prośbę o zaliczenie do {{ task.approver }}"><i
                                                    class="far fa-clock"></i></span></div>
                                        </td>
                                    {% elif task.status == 3 %}
                                    <td><span class="has-tooltip-arrow has-tooltip-left"
                                        data-tooltip="{{ task.approval_date }} zadanie zostało odrzucone przez {{ task.approver }}"><i
                                        class="far fa-circle-xmark"></i></span></td>
                                    {% else %}
                                        <td>
                                            <div id="status-icon_{{ task.id }}"></div>
                                        </td>
                                    {% endif %}
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="box">
                W archiwum nie ma żadnej próby.
            </div>
        {% endif %}
    {% else %}
        <div class="box">
            Aby zobaczyć próby w archiwum musisz się najpierw zalogować.
        </div>
    {% endif %}
    <script>
        filter_by_patrol("all")

        function filter_by_patrol(c) {
            let x, i;
            x = document.getElementsByClassName("worksheet");
            // Add the "show" class (display:block) to the filtered elements, and remove the "show" class from the elements that are not selected
            for (i = 0; i < x.length; i++) {
                if (($(x[i]).attr('data-user-patrol') === c || c === "all") && $(x[i]).find(".title").text().toLowerCase().indexOf($("#worksheet_searchbar").val().toLowerCase()) > -1) {
                    AddClass(x[i], "show");
                } else {
                    RemoveClass(x[i], "show");
                }
            }
        }

        function filter_by_name(c) {
            let x, i;
            x = document.getElementsByClassName("worksheet");
            const selected_patrol = $('#patrol_selector').val();
            // Add the "show" class (display:block) to the filtered elements, and remove the "show" class from the elements that are not matching the search query
            for (i = 0; i < x.length; i++) {
                if ($(x[i]).find(".title").text().toLowerCase().indexOf(c.toLowerCase()) > -1 && (selected_patrol === "all" || $(x[i]).attr('data-user-patrol') === selected_patrol)) {
                    AddClass(x[i], "show");
                } else {
                    RemoveClass(x[i], "show");
                }
            }
        }

        // Show filtered elements
        function AddClass(element, name) {
            var i, arr1, arr2;
            arr1 = element.className.split(" ");
            arr2 = name.split(" ");
            for (i = 0; i < arr2.length; i++) {
                if (arr1.indexOf(arr2[i]) === -1) {
                    element.className += " " + arr2[i];
                }
            }
        }

        // Hide elements that are not selected
        function RemoveClass(element, name) {
            var i, arr1, arr2;
            arr1 = element.className.split(" ");
            arr2 = name.split(" ");
            for (i = 0; i < arr2.length; i++) {
                while (arr1.indexOf(arr2[i]) > -1) {
                    arr1.splice(arr1.indexOf(arr2[i]), 1);
                }
            }
            element.className = arr1.join(" ");
        }
    </script>
    <style>
        .worksheet {
            display: none; /* Hidden by default */
        }

        .show {
            display: block;
        }
    </style>
{% endblock %}
